#!/usr/bin/env lua
-- LuaJIT bundler/builder
-- Made by vifino

-- Helper functions.
function file_exists(name)
	local f=io.open(name,"r")
	if f~=nil then
		io.close(f)
		return true
	else
		return false 
	end
end
function ansiescape(num) 
	return (string.char(27) .. '[%dm'):format(num)
end
function perror(...)
	print(ansiescape(31).."[ERROR]".. ansiescape(0) .. " "..table.concat({...},"\t"))
end
function pwarn(...)
	print(ansiescape(33).."[WARNG]".. ansiescape(0) .. " "..table.concat({...},"\t"))
end
function pinfo(...)
	print(ansiescape(32).."[INFO]".. ansiescape(0) .. " "..table.concat({...},"\t"))
end

function werror(...)
	io.write(ansiescape(31).."[ERROR]".. ansiescape(0) .. " "..table.concat({...},"\t"))
end
function wwarn(...)
	io.write(ansiescape(33).."[WARNING]".. ansiescape(0) .. " "..table.concat({...},"\t"))
end
function winfo(...)
	io.write(ansiescape(32).."[INFO]".. ansiescape(0) .. " "..table.concat({...},"\t"))
end
-- Done.

-- Option parser

function getopt( options )
	local tab = {}
	for k, v in ipairs(arg) do
		if string.sub( v, 1, 2) == "--" then
			table.remove(arg,k)
			local x = string.find( v, "=", 1, true )
			if x then tab[ string.sub( v, 3, x-1 ) ] = string.sub( v, x+1 )
			else      tab[ string.sub( v, 3 ) ] = true
			end
		elseif string.sub( v, 1, 1 ) == "-" then
			table.remove(arg,k)
			local y = 2
			local l = string.len(v)
			local jopt
			while ( y <= l ) do
				jopt = string.sub( v, y, y )
				tab[ jopt ] = true
				y = y + 1
			end
		end
	end
	return tab
end
-- Done.

-- Option parsing functions.
local optionlist = "h"
local optionstore = {}
local optioninfo = {}
local afterhooks = {}

function addOption(character,fun, info)
	optionlist = optionlist .. character
	optionstore[character] = fun
	if info then
		optioninfo[character] = info
	end
end
function addPostProcessor(func)
	table.insert(afterhooks, func)
end
-- Options here.

addOption("s", function() -- Strip
	addPostProcessor(function()
		winfo("Stripping... ")
		os.execute("strip --strip-all "..arg[2])
		print("Done.")
	end)
end, "Strip output file using 'strip --strip-all'")

addOption("c", function() -- UPX
	addPostProcessor(function()
		winfo("Compacting... ")
		io.popen("upx -9 "..arg[2],"r"):close()
		print("Done.")
	end)
end, "Compact output using 'upx -9'")

addOption("m", function() -- Mono color.
	function perror(...)
		print("[ERROR] "..table.concat({...},"\t"))
	end
	function pwarn(...)
		print("[WARNG] "..table.concat({...},"\t"))
	end
	function pinfo(...)
		print("[INFO] "..table.concat({...},"\t"))
	end
	function werror(...)
		io.write("[ERROR] "..table.concat({...},"\t"))
	end
	function wwarn(...)
		io.write("[WARNING] "..table.concat({...},"\t"))
	end
	function winfo(...)
		io.write("[INFO] "..table.concat({...},"\t"))
	end
end, "Don't use colors.")

-- Done
options = getopt(optionlist)
if ((not (#arg >=2)) or options["h"]) then
	print("Usage: "..arg[0].." [-"..optionlist.."] file.lua output_binary [Extra_lua_modules_or_objects]")
	print("\t-h: Show this help.")
	for k,v in pairs(optioninfo) do
		print("\t-"..k..": "..tostring(v))
	end
	if not options["h"] then
		os.exit(1)
end
end
for k,v in pairs(optionstore) do
	if options[k] then
		v()
	end
end
-- Done

-- Some error checking beforehand.
if not file_exists(arg[1]) then
	perror(string.format("Could not find file: %s", arg[1]))
	os.exit(1)
end

if file_exists(arg[2]) then
	perror("Output file exists, aborting..")
	os.exit(1)
end

-- Old Option parsing actions.
--[[
if options["s"] then
	-- Strip file
	table.insert(afterhooks, function()
		os.execute("strip --strip-all "..arg[2])
	end)
end

if options["u"] then
	-- UPX it!
	table.insert(afterhooks, function()
		os.execute("upx -9 "..arg[2])
	end)
end
]]
-- Done

local extra_c = os.getenv("ljb_cadd") or ""
local code = [[
#include <stdio.h>
#include "lua.h"
#include "lualib.h"
#include "lauxlib.h"

int main(int argc, char *argv[]) {
  int i;
  lua_State* L = luaL_newstate();
  if (!L) {
    printf("Unable to initialize LuaJIT!\n");
  }
  luaL_openlibs(L);
]] .. extra_c .. [[ 
	lua_newtable(L);
  for (i = 0; i < argc; i++) {
    lua_pushnumber(L, i);
    lua_pushstring(L, argv[i]);
    lua_settable(L, -3);
  }
  lua_setglobal(L, "arg");
  int ret = luaL_dostring(L, "require \"main\"");
  if (ret != 0) {
    printf(lua_tolstring(L, -1, 0));
    printf("\n");
    return ret;
  }
  return 0;
}
]]

local args = ""
local extra_objects = {}

if os.getenv("luajit_src") then
	args = args .. "-I"..os.getenv("luajit_src")
end
if os.getenv("luajit_lib") then
        args = "-l"..os.getenv("luajit_lib") .. " " .. args
end
if os.getenv("luajit_obj") then
        args = args .. " " .. os.getenv("luajit_obj")
end
if not (os.getenv("luajit_obj") or os.getenv("luajit_lib")) then 
	args = "-lluajit-5.1 " .. args
end
-- Actual compilation.
local function buildObj(infile, outfile, name)
	local dir, filename, extension = string.match(infile, "(.-)([^/]-([^%.]+))$")
	name = name or filename:gsub("%.lua$","")
	os.execute(string.format("%s -b -n "..name.." %s %s", (os.getenv("luajit_bin") or "luajit"), infile, outfile))
end
local function compile(fargs)
	local b = io.popen(string.format([[
	%s -O3 -Wall -Wl,-E \
		-x c %s -x none %s \
		%s \
		-o %s -lm -ldl -flto ]], (os.getenv("CC") or "gcc"), "-" ,(arg[1]..".o"), fargs.." ".. table.concat(extra_objects," "), arg[2]), "w")
	b:write(code)
	b:close()
	os.execute("rm -rf "..arg[1]..".o")
end
buildObj(arg[1], (arg[1]..".o"), "main")
if #arg >= 3 then
	for i=3, #arg, 1 do
		if arg[i]:match("%.lua$") then
			buildObj(arg[i],arg[i]..".o")
			table.insert(extra_objects,arg[i]..".o")
		else
			table.insert(extra_objects,arg[i])
		end
	end
end
local ret = compile(args)
for k,v in pairs(afterhooks) do
	v()
end
